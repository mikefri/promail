<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>ProMail Final</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f0f2f5; display: flex; justify-content: center; }
        .card { background: white; width: 100%; max-width: 400px; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h2 { color: #1a73e8; text-align: center; font-size: 1.2rem; }
        input, textarea { width: 100%; margin: 10px 0; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        button { width: 100%; padding: 12px; background: #1a73e8; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #res { margin-top: 20px; padding: 15px; background: #f8f9fa; border-left: 4px solid #1a73e8; display: none; white-space: pre-wrap; }
        .loader { display: none; color: #666; font-size: 0.8rem; margin-top: 10px; text-align: center; }
    </style>
</head>
<body>
    <div class="card">
        <h2>ProMail Expert</h2>
        <input type="password" id="tk" placeholder="Colle ton token hf_..." onchange="localStorage.setItem('tp_mail', this.value)">
        <textarea id="msg" rows="5" placeholder="Ton texte ici..."></textarea>
        <button onclick="send()">Transformer en message Pro</button>
        <div id="lod" class="loader">⚙️ Connexion à l'IA en cours...</div>
        <div id="res"></div>
    </div>

    <script>
        // Restauration auto du token
        document.getElementById('tk').value = localStorage.getItem('tp_mail') || '';

        async function send() {
            const t = document.getElementById('tk').value.trim();
            const m = document.getElementById('msg').value.trim();
            const out = document.getElementById('res');
            const lod = document.getElementById('lod');

            if(!t || !m) return alert("Complète les champs !");

            lod.style.display = "block";
            out.style.display = "none";

            try {
                const response = await fetch("https://api-inference.huggingface.co/models/google/gemma-1.1-7b-it", {
                    method: "POST",
                    headers: { 
                        "Authorization": `Bearer ${t}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ 
                        inputs: "Réécris ce message de façon professionnelle en français : " + m,
                        parameters: { return_full_text: false }
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Gemma renvoie parfois un tableau, parfois un objet
                    const result = Array.isArray(data) ? data[0].generated_text : data.generated_text;
                    out.innerText = result.trim();
                    out.style.display = "block";
                } else {
                    alert("Erreur IA : " + (data.error || "Problème de clé"));
                }
            } catch (err) {
                alert("Blocage de sécurité persistant. Vérifie que ton token est bien un token 'READ'.");
            } finally {
                lod.style.display = "none";
            }
        }
    </script>
</body>
</html>
